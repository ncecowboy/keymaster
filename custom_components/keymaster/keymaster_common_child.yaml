## WARNING ##
# This file is automatically generated, any changes
# will be overwritten.
#
# OPTIMIZATION NOTE:
# This common child template has been optimized to reduce automation overhead:
# - Autolock management: 8 automations â†’ 1 consolidated automation per lock
# - Uses trigger IDs and choose conditions for event-based routing
# - Queued mode ensures proper event sequencing
# This change improves Home Assistant performance and maintainability.
##

##################################################
################  COMMON ENTITIES  ###############
##################################################

###############  input_boolean:  #################
input_boolean:
  LOCKNAME_lock_notifications:
    name: CASE_LOCK_NAME Lock Notifications
  LOCKNAME_dooraccess_notifications:
    name: CASE_LOCK_NAME Door Notifications
  LOCKNAME_garageacess_notifications:
    name: CASE_LOCK_NAME Garage Notifications
  LOCKNAME_reset_lock:
    name: CASE_LOCK_NAME reset lock
  keymaster_LOCKNAME_autolock:
    name: "Auto Lock Enabled"
    icon: mdi:key-remove
  keymaster_LOCKNAME_retry:
    name: "Auto Lock Enabled"

###################  script:  ####################
script:
  keymaster_LOCKNAME_reset_lock:
    sequence:
      - service: script.keymaster_LOCKNAME_manual_notify
        data:
          title: "reset"
          message: "LOCKNAME"

  keymaster_LOCKNAME_reset_codeslot:
    mode: parallel
    fields:
      code_slot:
        description: The code slot to reset
        example: 1
    variables:
      # Constant used later to loop through day specific entities
      days: ["sun", "mon", "tue", "wed", "thu", "fri", "sat"]
    sequence:
      - service: input_boolean.turn_off
        data:
          entity_id: "input_boolean.enabled_LOCKNAME_{{ code_slot | string }}"
      - service: input_text.set_value
        data:
          entity_id: "input_text.LOCKNAME_name_{{ code_slot | string }}"
          value: ""
      - service: input_text.set_value
        data:
          entity_id: "input_text.LOCKNAME_pin_{{ code_slot | string }}"
          value: ""
      - service: input_boolean.turn_off
        data:
          entity_id: "input_boolean.notify_LOCKNAME_{{ code_slot | string }}"
      - service: input_number.set_value
        data:
          entity_id: "input_number.accesscount_LOCKNAME_{{ code_slot | string }}"
          value: "0"
      - service: input_datetime.set_datetime
        data:
          entity_id: "input_datetime.start_date_LOCKNAME_{{ code_slot | string }}"
          datetime: >-
            {{ now().strftime('%Y-%m-%d 00:00') }}
      - service: input_datetime.set_datetime
        data:
          entity_id: "input_datetime.end_date_LOCKNAME_{{ code_slot | string }}"
          datetime: >-
            {{ now().strftime('%Y-%m-%d 00:00') }}
      - service: input_boolean.turn_off
        data:
          entity_id: "input_boolean.daterange_LOCKNAME_{{ code_slot | string }}"
      - service: input_boolean.turn_off
        data:
          entity_id: "input_boolean.accesslimit_LOCKNAME_{{ code_slot | string }}"
      - service: input_boolean.turn_off
        data:
          entity_id: "input_boolean.reset_codeslot_LOCKNAME_{{ code_slot | string }}"
      # Loop through each day of the week and reset the entities related to each one
      - repeat:
          count: 7
          sequence:
            - service: input_datetime.set_datetime
              data:
                entity_id: "input_datetime.{{ days[repeat.index - 1] }}_start_date_LOCKNAME_{{ code_slot | string }}"
                time: "{{ now().replace(hour=00,minute=00,second=00).strftime('%H:%M:%S') }}"
            - service: input_datetime.set_datetime
              data:
                entity_id: "input_datetime.{{ days[repeat.index - 1] }}_end_date_LOCKNAME_{{ code_slot | string }}"
                time: "{{ now().replace(hour=00,minute=00,second=00).strftime('%H:%M:%S') }}"
            - service: input_boolean.turn_on
              data:
                entity_id: "input_boolean.{{ days[repeat.index - 1] }}_LOCKNAME_{{ code_slot | string }}"
            - service: input_boolean.turn_on
              data:
                entity_id: "input_boolean.{{ days[repeat.index - 1] }}_inc_LOCKNAME_{{ code_slot | string }}"

  keymaster_LOCKNAME_start_timer:
    sequence:
      - condition: state
        entity_id: input_boolean.keymaster_LOCKNAME_autolock
        state: "on"
      - condition: state
        entity_id: LOCKENTITYNAME
        state: "unlocked"
      - service: timer.cancel
        entity_id: timer.keymaster_LOCKNAME_autolock
      - service: timer.start
        data: # if next_dusk happens sooner than next_dawn, then it's daylight
          entity_id: timer.keymaster_LOCKNAME_autolock
          duration: >
            {% if (((as_timestamp(states.sun.sun.attributes.next_dusk)) > (as_timestamp(states.sun.sun.attributes.next_dawn)))) %}
              {{ states('input_text.keymaster_LOCKNAME_autolock_door_time_night')}}
            {% else %}
              {{ states('input_text.keymaster_LOCKNAME_autolock_door_time_day')}}
            {% endif %}

  boltchecked_lock_LOCKNAME:
    sequence:
      - service: lock.lock
        data:
          entity_id: LOCKENTITYNAME

  boltchecked_retry_LOCKNAME:
    sequence:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.keymaster_LOCKNAME_retry
      - service: persistent_notification.create
        data:
          title: "Unable to lock LOCKNAME"
          message: >-
            {{ 'Unable to lock LOCKNAME as the sensor indicates the door is currently opened.  The operation will be automatically retried when the door is closed.'}}

###################  automation:  ####################
automation:
  - alias: keymaster_CASE_LOCK_NAME Reset Code Slot
    id: keymaster_CASE_LOCK_NAME Reset Code Slot
    trigger:
      entity_id: INPUT_RESET_CODE_SLOT_HEADER
      platform: state
      to: "on"
    action:
      - service: script.keymaster_LOCKNAME_reset_codeslot
        data:
          code_slot: "{{ trigger.entity_id.split('_')[-1] }}"

  - alias: keymaster_CASE_LOCK_NAME Lock Notifications
    id: keymaster_CASE_LOCK_NAME Lock Notifications
    trigger:
      platform: event
      event_type: keymaster_lock_state_changed
      event_data:
        lockname: LOCKNAME
    condition:
      - condition: state
        entity_id: input_boolean.LOCKNAME_lock_notifications
        state: "on"
    action:
      - service: script.keymaster_LOCKNAME_manual_notify
        data:
          title: CASE_LOCK_NAME
          message: "{{ trigger.event.data.action_text }} {% if trigger.event.data.code_slot > 0 %}({{ trigger.event.data.code_slot_name }}){% endif %}"

  - alias: keymaster_CASE_LOCK_NAME User Notifications
    id: keymaster_CASE_LOCK_NAME User Notifications
    trigger:
      platform: event
      event_type: keymaster_lock_state_changed
      event_data:
        lockname: LOCKNAME
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.code_slot > 0 }}"
      - condition: template
        value_template: "{{ is_state('input_boolean.notify_LOCKNAME_' + trigger.event.data.code_slot | string, 'on') }}"
      - condition: state
        entity_id: input_boolean.LOCKNAME_lock_notifications
        state: "off"
    action:
      - service: script.keymaster_LOCKNAME_manual_notify
        data:
          title: CASE_LOCK_NAME
          message: "{{ trigger.event.data.action_text }} ({{ trigger.event.data.code_slot_name }})"

  - alias: keymaster_CASE_LOCK_NAME Door Open and Close
    id: keymaster_CASE_LOCK_NAME Door Open and Close
    trigger:
      entity_id: DOORSENSORENTITYNAME
      platform: state
    condition:
      - condition: state
        entity_id: "input_boolean.LOCKNAME_dooraccess_notifications"
        state: "on"
      - condition: template
        value_template: "{{ trigger.from_state.state in ('on', 'off') and trigger.to_state.state in ('on', 'off') }}"
    action:
      - service: script.keymaster_LOCKNAME_manual_notify
        data:
          title: CASE_LOCK_NAME
          message: "{% if trigger.to_state.state == 'on' %}Door Opened{% else %}Door Closed{% endif %}"

  - alias: keymaster_CASE_LOCK_NAME Changed Code
    id: keymaster_CASE_LOCK_NAME Changed Code
    trigger:
      entity_id: INPUTLOCKPINHEADER
      platform: state
    condition:
      - condition: template
        value_template: >-
          {{
            is_state('input_boolean.enabled_LOCKNAME_' + trigger.entity_id.split('_')[-1], 'on')
            and
            (trigger.from_state.state != trigger.to_state.state)
          }}
    action:
      - service: persistent_notification.create
        data:
          title: CASE_LOCK_NAME LOCK MANAGER
          message: >-
            {{ 'You changed the PIN for CASE_LOCK_NAME code slot ' + trigger.entity_id.split('_')[-1] + '. Please enable it in order to make it active.'}}
      - service: input_boolean.turn_off
        data:
          entity_id: >-
            {{ 'input_boolean.enabled_LOCKNAME_' + trigger.entity_id.split('_')[-1] }}

  - alias: keymaster_CASE_LOCK_NAME Reset
    id: keymaster_CASE_LOCK_NAME Reset
    trigger:
      entity_id: input_boolean.LOCKNAME_reset_lock
      platform: state
      from: "off"
      to: "on"
    action:
      - service: script.keymaster_LOCKNAME_reset_lock
      - service: input_boolean.turn_off
        entity_id: input_boolean.LOCKNAME_reset_lock

  - alias: keymaster_CASE_LOCK_NAME Decrement Access Count
    id: keymaster_CASE_LOCK_NAME Decrement Access Count
    trigger:
      platform: event
      event_type: keymaster_lock_state_changed
      event_data:
        lockname: LOCKNAME
    condition:
      - condition: template
        # make sure decrementing access entries is enabled
        value_template: "{{ is_state('input_boolean.accesslimit_LOCKNAME_' + trigger.event.data.code_slot | string, 'on') }}"
      - condition: template
        # Check for Keypad Unlock code
        value_template: >-
          {{
            trigger.event.data.code_slot > 0
            and
            (trigger.event.data.action_code is undefined or trigger.event.data.action_code in (6, 19))
          }}
    action:
      - service: input_number.decrement
        data:
          entity_id: "{{ 'input_number.accesscount_LOCKNAME_' + trigger.event.data.code_slot | string }}"

  # Consolidated autolock automation - handles lock/unlock events and timer management
  - alias: keymaster_LOCKNAME_autolock_manager
    id: keymaster_LOCKNAME_autolock_manager
    mode: queued
    trigger:
      # Lock state changed to locked - cancel timer
      - platform: state
        entity_id: LOCKENTITYNAME
        to: locked
        id: locked
      # Lock state changed to unlocked - start timer
      - platform: state
        entity_id: LOCKENTITYNAME
        to: unlocked
        id: unlocked
      # Door sensor opened - start/restart timer
      - platform: state
        entity_id: DOORSENSORENTITYNAME
        to: "on"
        id: door_opened
      # Door sensor closed (for retry logic)
      - platform: state
        entity_id: DOORSENSORENTITYNAME
        to: "off"
        id: door_closed
      # Autolock toggle turned off - cancel timer
      - platform: state
        entity_id: input_boolean.keymaster_LOCKNAME_autolock
        to: "off"
        id: autolock_disabled
      # Autolock toggle turned on - start timer if unlocked
      - platform: state
        entity_id: input_boolean.keymaster_LOCKNAME_autolock
        to: "on"
        id: autolock_enabled
      # Timer finished - lock the door
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.keymaster_LOCKNAME_autolock
        id: timer_finished
      # Timer cancelled - cleanup
      - platform: event
        event_type: timer.cancelled
        event_data:
          entity_id: timer.keymaster_LOCKNAME_autolock
        id: timer_cancelled
    action:
      - choose:
          # Lock state changed to locked - cancel timer and turn off retry
          - conditions:
              - condition: trigger
                id: locked
            sequence:
              - service: timer.cancel
                entity_id: timer.keymaster_LOCKNAME_autolock
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.keymaster_LOCKNAME_retry
          
          # Lock state changed to unlocked - start timer if autolock enabled
          - conditions:
              - condition: trigger
                id: unlocked
              - condition: state
                entity_id: input_boolean.keymaster_LOCKNAME_autolock
                state: "on"
            sequence:
              - service: script.turn_on
                entity_id: script.keymaster_LOCKNAME_start_timer
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.keymaster_LOCKNAME_retry
          
          # Door opened - start timer if autolock enabled
          - conditions:
              - condition: trigger
                id: door_opened
              - condition: state
                entity_id: input_boolean.keymaster_LOCKNAME_autolock
                state: "on"
            sequence:
              - service: timer.start
                data:
                  entity_id: timer.keymaster_LOCKNAME_autolock
                  duration: >
                    {% if (((as_timestamp(states.sun.sun.attributes.next_dusk)) > (as_timestamp(states.sun.sun.attributes.next_dawn)))) %}
                      {{ states('input_text.keymaster_LOCKNAME_autolock_door_time_night')}}
                    {% else %}
                      {{ states('input_text.keymaster_LOCKNAME_autolock_door_time_day')}}
                    {% endif %}
          
          # Door closed - retry lock if retry flag is set
          - conditions:
              - condition: trigger
                id: door_closed
              - condition: state
                entity_id: input_boolean.keymaster_LOCKNAME_retry
                state: "on"
              - condition: state
                entity_id: input_boolean.keymaster_LOCKNAME_autolock
                state: "on"
            sequence:
              - service: persistent_notification.create
                data:
                  title: "LOCKNAME is closed"
                  message: >-
                    {{ 'The LOCKNAME sensor indicates the door has been closed, re-attempting to lock.'}}
              - service: lock.lock
                entity_id: lock.boltchecked_LOCKNAME
          
          # Autolock disabled - cancel timer and turn off retry
          - conditions:
              - condition: trigger
                id: autolock_disabled
            sequence:
              - service: timer.cancel
                entity_id: timer.keymaster_LOCKNAME_autolock
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.keymaster_LOCKNAME_retry
          
          # Autolock enabled - cancel timer, turn off retry, and start timer if unlocked
          - conditions:
              - condition: trigger
                id: autolock_enabled
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.keymaster_LOCKNAME_retry
              - service: timer.cancel
                entity_id: timer.keymaster_LOCKNAME_autolock
              - service: script.turn_on
                entity_id: script.keymaster_LOCKNAME_start_timer
          
          # Timer finished - lock the door if autolock is still enabled
          - conditions:
              - condition: trigger
                id: timer_finished
              - condition: state
                entity_id: input_boolean.keymaster_LOCKNAME_autolock
                state: "on"
            sequence:
              - service: lock.lock
                entity_id: lock.boltchecked_LOCKNAME
          
          # Timer cancelled - turn off retry flag
          - conditions:
              - condition: trigger
                id: timer_cancelled
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.keymaster_LOCKNAME_retry

  - alias: keymaster_LOCKNAME_initialize
    id: keymaster_LOCKNAME_initialize
    trigger:
      platform: homeassistant
      event: start
    action:
      - service: input_text.set_value
        entity_id: input_text.keymaster_LOCKNAME_autolock_door_time_day
        data:
          value: >
            {%- set current_value=states('input_text.keymaster_LOCKNAME_autolock_door_time_day') -%}
            {{ iif(current_value in ['', 'unknown'], "02:00:00", current_value)}}
      - service: input_text.set_value
        entity_id: input_text.keymaster_LOCKNAME_autolock_door_time_night
        data:
          value: >
            {%- set current_value=states('input_text.keymaster_LOCKNAME_autolock_door_time_night') -%}
            {{ iif(current_value in ['', 'unknown'], "00:05:00", current_value)}}

###################  timer:  ####################
timer:
  keymaster_LOCKNAME_autolock:
    name: "Auto Lock Timer"

###################  template:  ####################
template:
  - lock:
      - name: boltchecked_LOCKNAME
        unique_id: "lock.boltchecked_LOCKNAME"
        state: "{{ is_state('LOCKENTITYNAME', 'locked') }}"
        lock:
          service: "{{ 'script.boltchecked_retry_LOCKNAME' if (is_state('DOORSENSORENTITYNAME', 'on')) else 'script.boltchecked_lock_LOCKNAME' }}"
        unlock:
          service: lock.unlock
          data:
            entity_id: LOCKENTITYNAME

###############  input_text:  #################
input_text:
  LOCKNAME_lockname:
    initial: LOCKNAME
    name: "Lock Name"

  keymaster_LOCKNAME_autolock_door_time_day:
    name: "Day Auto Lock HH:MM:SS"
  keymaster_LOCKNAME_autolock_door_time_night:
    name: "Night Auto Lock HH:MM:SS"

  ###############  PARENT entities  #################
  LOCKNAME_PARENTLOCK_parent:
    initial: PARENTLOCK
    name: "Parent lock"
